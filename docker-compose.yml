# =============================================================================
# Disclaude Docker Compose Configuration
# =============================================================================
#
# Architecture: Two-node distributed system
# - Communication Node: Handles Feishu WebSocket connections
# - Execution Node: Handles Pilot/Agent task execution
#
# Usage:
#   cp disclaude.config.example.yaml disclaude.config.yaml
#   # Edit disclaude.config.yaml with your API keys and settings
#   docker compose up -d
#
#   # View logs
#   docker compose logs -f
#
#   # Stop
#   docker compose down
#
# =============================================================================

services:
  # Communication Node (Feishu WebSocket handler)
  comm:
    build:
      context: .
      dockerfile: Dockerfile
    image: disclaude:latest
    container_name: disclaude-comm
    restart: unless-stopped

    # Command: run Communication Node
    command: ["node", "dist/cli-entry.js", "start", "--mode", "comm"]

    # Network mode: host allows container to access host's CDP endpoint
    network_mode: host

    environment:
      - NODE_ENV=production
      - TZ=Asia/Shanghai
      - GITHUB_TOKEN=${GITHUB_TOKEN}

    volumes:
      - ./disclaude.config.yaml:/app/disclaude.config.yaml:ro
      - ./workspace:/app/workspace
      - ./logs:/app/logs

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*cli-entry.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Execution Node (Pilot/Agent handler)
  exec:
    build:
      context: .
      dockerfile: Dockerfile
    image: disclaude:latest
    container_name: disclaude-exec
    restart: unless-stopped

    # Command: run Execution Node, connect to Communication Node
    command: ["node", "dist/cli-entry.js", "start", "--mode", "exec", "--comm-url", "ws://localhost:3001"]

    # Network mode: host for local connection to comm node
    network_mode: host

    environment:
      - NODE_ENV=production
      - TZ=Asia/Shanghai
      - GITHUB_TOKEN=${GITHUB_TOKEN}

    volumes:
      - ./disclaude.config.yaml:/app/disclaude.config.yaml:ro
      - ./workspace:/app/workspace
      - ./logs:/app/logs

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*cli-entry.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Depends on comm node
    depends_on:
      comm:
        condition: service_healthy
