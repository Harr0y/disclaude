# =============================================================================
# Disclaude Docker Compose Configuration
# =============================================================================
#
# Usage:
#   cp disclaude.config.example.yaml disclaude.config.yaml
#   # Edit disclaude.config.yaml with your API keys and settings
#   docker compose up -d
#
#   # View logs
#   docker compose logs -f
#
#   # Stop
#   docker compose down
#
# =============================================================================

services:
  disclaude:
    build:
      context: .
      dockerfile: Dockerfile
    image: disclaude:latest
    container_name: disclaude-feishu
    restart: unless-stopped

    # Network mode: host allows container to access host's CDP endpoint
    # Alternative: use extra_hosts for host.docker.internal (see comments below)
    network_mode: host

    # Environment variables (optional overrides)
    environment:
      - NODE_ENV=production
      - TZ=Asia/Shanghai
      # GitHub token for git operations (clone private repos, create PRs, etc.)
      # Create at: https://github.com/settings/tokens
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      # Note: CDP endpoint for Playwright MCP is configured in disclaude.config.yaml
      # via the --cdp-endpoint argument, not as an environment variable.
      # For network_mode: host, use: http://localhost:9222
      # For Docker Desktop, use: http://host.docker.internal:9222

    # For Docker Desktop on Mac/Windows, uncomment this and remove network_mode: host
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"

    # Mount configuration file (required)
    volumes:
      # Mount your configuration file with API keys
      - ./disclaude.config.yaml:/app/disclaude.config.yaml:ro

      # Persist workspace directory
      - ./workspace:/app/workspace

      # Persist logs
      - ./logs:/app/logs

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node.*cli-entry.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
